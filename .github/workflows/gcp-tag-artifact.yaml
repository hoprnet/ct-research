name: GCP Artifact Tagging

on:
  release:
    types:
      - published

jobs:
  tag-artifact:
    name: Tag GCP artifact
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Login to GCP
      id: gcloud
      uses: elgohr/gcloud-login-action@v1 #TODO - v2 is bugged, unable to get outputs
      with:
        account_key: ${{ secrets.GOOGLE_CREDENTIALS }}

    - name: Apply tag to GCP artifact
      run: |
        repository=${{ secrets.GOOGLE_PROJECT }}/${{ secrets.GOOGLE_REPOSITORY }}/cover-traffic
        docker_registry=${{ secrets.GOOGLE_REGION }}-docker.pkg.dev
        image=${{ secrets.GOOGLE_PROJECT }}/${{ secrets.GOOGLE_REPOSITORY }}/cover-traffic
        commit_tag=$(git rev-parse --short "$GITHUB_SHA")
        tag=${{ github.ref_name }}

        echo "Tag from release: ${tag}"
        echo "Short sha: ${commit_tag}"

        gcloud config set artifacts/repository $repository
        gcloud config set artifacts/location ${{ secrets.GOOGLE_REGION }}
        gcloud config set username ${{ steps.gcloud.outputs.username }}
        gcloud config set password ${{ steps.gcloud.outputs.password }}

        gcloud artifacts docker tags add ${docker_registry}/${image}:${commit_tag} ${docker_registry}/${image}:${tag}

      env:
        # Set environment variables needed for GCP commands
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}